<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>CS144 Lab Checkpoint 6: building an IP router - ZonePG</title><meta name="viewport" content="width=device-width, initial-scale=1">

	<meta property="og:image" content=""/>
	<meta property="og:title" content="CS144 Lab Checkpoint 6: building an IP router" />
<meta property="og:description" content="Lab6 在 Lab5 实现的 network interface 基础上，构建一个 IP 路由器。路由器有多个 network interface，并能接受任意一个 network interface 的 IP 报文。总结来说，路由器的任务就是根据路由表转发 IP 报文。
对于给定 IP 报文，路由表负责以下任务：
要将 IP 报文给哪一个 network interface。 下一跳的 IP 地址。 Implementing the Router Router 类可以：
追踪路由表 将收到的 IP 报文在正确的传出网络接口(network interface)上转发给正确的下一跳 add_route 为路由表添加路由规则。
// router.hh class Router { ... struct route_entry { uint32_t _route_prefix{}; uint8_t _prefix_length{}; std::optional&lt;Address&gt; _next_hop{}; size_t interface_num{}; }; std::vector&lt;route_entry&gt; _routes{}; ... }; // router.cc void Router::add_route(const uint32_t route_prefix, const uint8_t prefix_length, const optional&lt;Address&gt; next_hop, const size_t interface_num) { cerr &lt;&lt; &#34;DEBUG: adding route &#34; &lt;&lt; Address::from_ipv4_numeric(route_prefix)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zonepg.github.io/posts/programming/net/2022-01-19-cs144-lab6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-01-19T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CS144 Lab Checkpoint 6: building an IP router"/>
<meta name="twitter:description" content="Lab6 在 Lab5 实现的 network interface 基础上，构建一个 IP 路由器。路由器有多个 network interface，并能接受任意一个 network interface 的 IP 报文。总结来说，路由器的任务就是根据路由表转发 IP 报文。
对于给定 IP 报文，路由表负责以下任务：
要将 IP 报文给哪一个 network interface。 下一跳的 IP 地址。 Implementing the Router Router 类可以：
追踪路由表 将收到的 IP 报文在正确的传出网络接口(network interface)上转发给正确的下一跳 add_route 为路由表添加路由规则。
// router.hh class Router { ... struct route_entry { uint32_t _route_prefix{}; uint8_t _prefix_length{}; std::optional&lt;Address&gt; _next_hop{}; size_t interface_num{}; }; std::vector&lt;route_entry&gt; _routes{}; ... }; // router.cc void Router::add_route(const uint32_t route_prefix, const uint8_t prefix_length, const optional&lt;Address&gt; next_hop, const size_t interface_num) { cerr &lt;&lt; &#34;DEBUG: adding route &#34; &lt;&lt; Address::from_ipv4_numeric(route_prefix)."/>
<script src="https://zonepg.github.io/js/feather.min.js"></script>
	
	<link href="https://zonepg.github.io/css/fonts.css" rel="stylesheet">
	
	<link rel="stylesheet" type="text/css" media="screen" href="https://zonepg.github.io/css/main.css" />
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://zonepg.github.io/">ZonePG</a>
	</div>
	<nav>
		
	</nav>
	
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">CS144 Lab Checkpoint 6: building an IP router</h1>
			<div class="meta">Posted on Jan 19, 2022</div>
		</div>
		

		<section class="body">
			<p><img src="/net/cs144-lab5/lab-overview.png" alt="lab-overview"></p>
<p>Lab6 在 Lab5 实现的 network interface 基础上，构建一个 IP 路由器。路由器有多个 network interface，并能接受任意一个 network interface 的 IP 报文。总结来说，路由器的任务就是根据路由表转发 IP 报文。</p>
<p>对于给定 IP 报文，路由表负责以下任务：</p>
<ul>
<li>要将 IP 报文给哪一个 network interface。</li>
<li>下一跳的 IP 地址。</li>
</ul>
<h2 id="implementing-the-router">Implementing the Router</h2>
<p><strong>Router</strong> 类可以：</p>
<ul>
<li>追踪路由表</li>
<li>将收到的 IP 报文在正确的传出网络接口(network interface)上转发给正确的下一跳</li>
</ul>
<h3 id="add_route">add_route</h3>
<p>为路由表添加路由规则。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">// router.hh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Router</span> {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">route_entry</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32_t</span> _route_prefix{};
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint8_t</span> _prefix_length{};
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>optional<span style="color:#f92672">&lt;</span>Address<span style="color:#f92672">&gt;</span> _next_hop{};
</span></span><span style="display:flex;"><span>        size_t interface_num{};
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>route_entry<span style="color:#f92672">&gt;</span> _routes{};
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// router.cc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> Router<span style="color:#f92672">::</span>add_route(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint32_t</span> route_prefix,
</span></span><span style="display:flex;"><span>                       <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> prefix_length,
</span></span><span style="display:flex;"><span>                       <span style="color:#66d9ef">const</span> optional<span style="color:#f92672">&lt;</span>Address<span style="color:#f92672">&gt;</span> next_hop,
</span></span><span style="display:flex;"><span>                       <span style="color:#66d9ef">const</span> size_t interface_num) {
</span></span><span style="display:flex;"><span>    cerr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;DEBUG: adding route &#34;</span> <span style="color:#f92672">&lt;&lt;</span> Address<span style="color:#f92672">::</span>from_ipv4_numeric(route_prefix).ip() <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#66d9ef">int</span>(prefix_length)
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; =&gt; &#34;</span> <span style="color:#f92672">&lt;&lt;</span> (next_hop.has_value() <span style="color:#f92672">?</span> next_hop<span style="color:#f92672">-&gt;</span>ip() <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;(direct)&#34;</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; on interface &#34;</span> <span style="color:#f92672">&lt;&lt;</span> interface_num <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Your code here.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    _routes.push_back(route_entry{route_prefix, prefix_length, next_hop, interface_num});
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="route_one_datagram">route_one_datagram</h3>
<p>转发数据包给下一跳，从适当的接口传出。实现<code>longest-prefix match</code>逻辑，为路由器找到最佳匹配的路由规则。</p>
<ul>
<li>路由器搜索路由表，找到目的地址的最高有效前缀长度与路由规则的前缀的最高有效前缀长度相同。</li>
<li>如果没有匹配的路由，路由器丢弃数据报。</li>
<li>路由器减少数据报的 TTL(time to live)，如果 TTL 为 0，路由器丢弃数据报。</li>
<li>否则的话，路由器在适当的接口上转发数据报给下一跳。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Router<span style="color:#f92672">::</span>route_one_datagram(InternetDatagram <span style="color:#f92672">&amp;</span>dgram) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Your code here.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (dgram.header().ttl <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> match_index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span> max_match_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> _routes.size(); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32_t</span> mask <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            _routes[i]._prefix_length <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> numeric_limits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int32_t</span><span style="color:#f92672">&gt;::</span>min() <span style="color:#f92672">&gt;&gt;</span> (_routes[i]._prefix_length <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (max_match_len <span style="color:#f92672">&lt;=</span> _routes[i]._prefix_length <span style="color:#f92672">&amp;&amp;</span> (dgram.header().dst <span style="color:#f92672">&amp;</span> mask) <span style="color:#f92672">==</span> _routes[i]._route_prefix) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// for 0.0.0.0 _prefix_length = 0, &lt;= needed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            max_match_len <span style="color:#f92672">=</span> _routes[i]._prefix_length;
</span></span><span style="display:flex;"><span>            match_index <span style="color:#f92672">=</span> i;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (match_index <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    dgram.header().ttl<span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>_routes[match_index]._next_hop.has_value()) {
</span></span><span style="display:flex;"><span>        interface(_routes[match_index].interface_num)
</span></span><span style="display:flex;"><span>            .send_datagram(dgram, Address<span style="color:#f92672">::</span>from_ipv4_numeric(dgram.header().dst));
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        interface(_routes[match_index].interface_num).send_datagram(dgram, _routes[match_index]._next_hop.value());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/computer-networking">Computer Networking</a></li>
					
				</ul>
			</nav>
			
			
		</div>
	</article>
</main>
<footer>
<hr>

<a class="soc" href="https://github.com/zonepg" title="GitHub"><i data-feather="github"></i></a>|<a class="soc" href="https://zonepg.github.io/posts/index.xml" title="RSS"><i data-feather="rss"></i></a>|⚡️
	2023  @ ZonePG |  <a href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
</footer>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-0RR9DVCNMR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0RR9DVCNMR');
</script>
<script>
      feather.replace()
</script></div>
    </body>
</html>
