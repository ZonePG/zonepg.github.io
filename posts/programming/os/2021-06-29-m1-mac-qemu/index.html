<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>解决 M1 MAC 的 Qemu 使用问题 - ZonePG</title><meta name="viewport" content="width=device-width, initial-scale=1">

	<meta property="og:image" content=""/>
	<meta property="og:title" content="解决 M1 MAC 的 Qemu 使用问题" />
<meta property="og:description" content="本文可以帮助在M1 MAC上搭建起riscv32-system-qemu或riscv64-system-qemu的环境，不过仅适用与5.1.0版本的Qemu。
[2021-11-26] 更新 6.1&#43; 版本的 Qemu 已解决该问题。
问题重现 M1 Mac拿到手几个月内，因为一些软件的架构适配问题，十分头疼，其中包括Qemu的使用问题。
例如我在Github MIT 的 xv6 仓库提的一个issue， 当使用5.x.0以及6.0.0版本的Qemu会出现这样的情况：qemu-system-riscv64: qemu_mprotect__osdep: mprotect failed: Permission denied， 其原因可能是苹果的内存保护问题。
也尝试了rCore-Tutorial-Book-v3仓库的解决方案(issue)， 使用最新的补丁版本Qemu仓库，并对util/osdep.c文件作修改，虽然没有出现上面了情况了，系统启动会卡住。 以及 Qemu-5.2.0 不支持 RustSBI。
解决方案 google 了多方资料，最终发现了一个暂时可行的解决方案，如下方式可以在 M1 Mac上跑起来 Qemu。
下载 5.1.0 版本的 Qemu（6.0.0 打补丁后仍有问题） 下载这个补丁patch(series)，将其存放于Qemu的上级目录，patch -p1 &lt; ../patch/v2-tcg-Fix-execution-on-Apple-Silicon.patch安装补丁。 修改util/osdep.c文件的函数 int qemu_mprotect_none(void *addr, size_t size) { #ifdef _WIN32 return qemu_mprotect__osdep(addr, size, PAGE_NOACCESS); #elif defined(__APPLE__) &amp;&amp; defined(__arm64__) /* Workaround mprotect (RWX-&gt;NONE) issue on Big Sur 11.2 */ return 0; #else return qemu_mprotect__osdep(addr, size, PROT_NONE); 最后安装编译安装Qeme，并将build文件夹与build/riscv64-softmmu文件夹加入环境变量中 mkdir build &amp;&amp; cd build ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zonepg.github.io/posts/programming/os/2021-06-29-m1-mac-qemu/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-06-29T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="解决 M1 MAC 的 Qemu 使用问题"/>
<meta name="twitter:description" content="本文可以帮助在M1 MAC上搭建起riscv32-system-qemu或riscv64-system-qemu的环境，不过仅适用与5.1.0版本的Qemu。
[2021-11-26] 更新 6.1&#43; 版本的 Qemu 已解决该问题。
问题重现 M1 Mac拿到手几个月内，因为一些软件的架构适配问题，十分头疼，其中包括Qemu的使用问题。
例如我在Github MIT 的 xv6 仓库提的一个issue， 当使用5.x.0以及6.0.0版本的Qemu会出现这样的情况：qemu-system-riscv64: qemu_mprotect__osdep: mprotect failed: Permission denied， 其原因可能是苹果的内存保护问题。
也尝试了rCore-Tutorial-Book-v3仓库的解决方案(issue)， 使用最新的补丁版本Qemu仓库，并对util/osdep.c文件作修改，虽然没有出现上面了情况了，系统启动会卡住。 以及 Qemu-5.2.0 不支持 RustSBI。
解决方案 google 了多方资料，最终发现了一个暂时可行的解决方案，如下方式可以在 M1 Mac上跑起来 Qemu。
下载 5.1.0 版本的 Qemu（6.0.0 打补丁后仍有问题） 下载这个补丁patch(series)，将其存放于Qemu的上级目录，patch -p1 &lt; ../patch/v2-tcg-Fix-execution-on-Apple-Silicon.patch安装补丁。 修改util/osdep.c文件的函数 int qemu_mprotect_none(void *addr, size_t size) { #ifdef _WIN32 return qemu_mprotect__osdep(addr, size, PAGE_NOACCESS); #elif defined(__APPLE__) &amp;&amp; defined(__arm64__) /* Workaround mprotect (RWX-&gt;NONE) issue on Big Sur 11.2 */ return 0; #else return qemu_mprotect__osdep(addr, size, PROT_NONE); 最后安装编译安装Qeme，并将build文件夹与build/riscv64-softmmu文件夹加入环境变量中 mkdir build &amp;&amp; cd build ."/>
<script src="https://zonepg.github.io/js/feather.min.js"></script>
	
	<link href="https://zonepg.github.io/css/fonts.css" rel="stylesheet">
	
	<link rel="stylesheet" type="text/css" media="screen" href="https://zonepg.github.io/css/main.css" />
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://zonepg.github.io/">ZonePG</a>
	</div>
	<nav>
		
	</nav>
	
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">解决 M1 MAC 的 Qemu 使用问题</h1>
			<div class="meta">Posted on Jun 29, 2021</div>
		</div>
		

		<section class="body">
			<p>本文可以帮助在M1 MAC上搭建起<code>riscv32-system-qemu</code>或<code>riscv64-system-qemu</code>的环境，不过仅适用与<code>5.1.0</code>版本的Qemu。</p>
<h2 id="2021-11-26-更新">[2021-11-26] 更新</h2>
<p>6.1+ 版本的 Qemu 已解决该问题。</p>
<h2 id="问题重现">问题重现</h2>
<p>M1 Mac拿到手几个月内，因为一些软件的架构适配问题，十分头疼，其中包括Qemu的使用问题。</p>
<p>例如我在Github MIT 的 xv6 仓库提的一个<a href="https://github.com/mit-pdos/xv6-riscv/issues/76">issue</a>，
当使用<code>5.x.0</code>以及<code>6.0.0</code>版本的Qemu会出现这样的情况：<code>qemu-system-riscv64: qemu_mprotect__osdep: mprotect failed: Permission denied</code>，
其原因可能是苹果的内存保护问题。</p>
<p>也尝试了rCore-Tutorial-Book-v3仓库的解决方案<a href="https://github.com/rcore-os/rCore-Tutorial-Book-v3/issues/11">(issue)</a>，
使用最新的补丁版本Qemu仓库，并对<code>util/osdep.c</code>文件作修改，虽然没有出现上面了情况了，系统启动会卡住。
以及 Qemu-5.2.0 不支持 RustSBI。</p>
<h2 id="解决方案">解决方案</h2>
<p>google 了多方资料，最终发现了一个暂时可行的解决方案，如下方式可以在 M1 Mac上跑起来 Qemu。</p>
<ul>
<li>下载 5.1.0 版本的 Qemu（6.0.0 打补丁后仍有问题）</li>
<li>下载这个补丁<a href="https://patchwork.kernel.org/project/qemu-devel/patch/20210103145055.11074-1-r.bolshakov@yadro.com/">patch(series)</a>，将其存放于Qemu的上级目录，<code>patch -p1 &lt; ../patch/v2-tcg-Fix-execution-on-Apple-Silicon.patch</code>安装补丁。</li>
<li>修改<code>util/osdep.c</code>文件的函数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">qemu_mprotect_none</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr, size_t size)
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef _WIN32
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#66d9ef">return</span> qemu_mprotect__osdep(addr, size, PAGE_NOACCESS);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__APPLE__) &amp;&amp; defined(__arm64__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">/* Workaround mprotect (RWX-&gt;NONE) issue on Big Sur 11.2 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span> <span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#66d9ef">return</span> qemu_mprotect__osdep(addr, size, PROT_NONE);
</span></span></code></pre></div><ul>
<li>最后安装编译安装Qeme，并将<code>build</code>文件夹与<code>build/riscv64-softmmu</code>文件夹加入环境变量中</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>mkdir build <span style="color:#f92672">&amp;&amp;</span> cd build
</span></span><span style="display:flex;"><span>./configure --disable-kvm --disable-werror --target-list<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;riscv64-softmmu&#34;</span>
</span></span><span style="display:flex;"><span>make
</span></span></code></pre></div><p>这样 xv6 系统就可以工作了。</p>
<h2 id="补充">补充</h2>
<p>值得一提的是，由于现在的M1 MAC还不支持GDB，因此在使用 <code>riscv64-unknown-elf-gdb</code> 会出现缺少 python 依赖的问题。
从源码编译 GDB 的方式目前还不可行，需要 M1 MAC 支持 GDB。</p>
<p>Docker上支持的ARM镜像也较少。</p>
<p>不过M1 MAC的性能与续航十分优秀，软件生态还正在完善，相信完善度会越来越好。</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://patchwork.kernel.org/project/qemu-devel/patch/20210103145055.11074-1-r.bolshakov@yadro.com/">[v2] tcg: Fix execution on Apple Silicon</a></li>
<li><a href="https://github.com/mit-pdos/xv6-riscv/issues/76">Stuck when compiling on m1 chip mac os</a></li>
<li><a href="https://github.com/rcore-os/rCore-Tutorial-Book-v3/issues/11">rCore-Tutorial-Book-v3/chapter0/5setup-devel-env</a></li>
</ul>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/operating-system">Operating System</a></li>
					
				</ul>
			</nav>
			
			
		</div>
	</article>
</main>
<footer>
<hr>

<a class="soc" href="https://github.com/zonepg" title="GitHub"><i data-feather="github"></i></a>|<a class="soc" href="https://zonepg.github.io/posts/index.xml" title="RSS"><i data-feather="rss"></i></a>|⚡️
	2023  @ ZonePG |  <a href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
</footer>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-0RR9DVCNMR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0RR9DVCNMR');
</script>
<script>
      feather.replace()
</script></div>
    </body>
</html>
